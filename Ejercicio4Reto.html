<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Formulario de productos</title>
<style>
  table {
    border-collapse: collapse;
    width: 100%;
  }
  th, td {
    border: 1px solid #dddddd;
    text-align: left;
    padding: 8px;
  }
  th {
    background-color: #f2f2f2;
  }
  #error {
    color: red;
    font-weight: bold;
  }
</style>
</head>
<body>

<h1>Formulario de productos</h1>

<form id="productForm">
  <label for="descripcion">Descripción:</label>
  <input type="text" id="descripcion" name="descripcion" required><br><br>
  <label for="idProveedor">ID Proveedor:</label>
  <input type="number" id="idProveedor" name="idProveedor" required><br><br>
  <label for="precio">Precio:</label>
  <input type="number" id="precio" name="precio" step="1" required><br><br>
  <button type="submit", onclick="agregarelemnto()">Enviar</button>
</form>

<h2 id="error"></h2>

<table id="productTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>Descripción</th>
      <th>ID Proveedor</th>
      <th>Precio</th>
    </tr>
  </thead>
  <tbody>
    <!-- Los datos de los productos se llenarán aquí -->
  </tbody>
</table>
<script>
  let elementos = []; 

  function agregarelemnto() {
    let descripcion = document.getElementById("descripcion").value;
    let idProveedor = document.getElementById("idProveedor").value;
    let precio = document.getElementById("precio").value;
    let nuevoElemento = { descripcion, idProveedor, precio };
    elementos.push(nuevoElemento);
    //envio
    envio(nuevoElemento);
    let nuevaFila = generaTr(nuevoElemento);
    document.getElementById("productTable").innerHTML += nuevaFila;
    document.getElementById("descripcion").value = "";
    document.getElementById("idProveedor").value = "";
    document.getElementById("precio").value = "";
  }

  function generaTr(nuevoElemento) {
    return "<tr>"+
             "<td>" + nuevoElemento.descripcion + "</td>"+
             "<td>" + nuevoElemento.idProveedor + "</td>" +
             "<td>" + nuevoElemento.precio + "</td>" +
           "</tr>"; 
  }
</script>

<script>
function envio(objeto_js){
   	const xhr = new XMLHttpRequest();
   	xhr.open("POST", "https://lm.iesnervion.es/reto4.php");
	xhr.responseType = "json"; // Si no se indica, necesitará parseo

// Preparamos a continuación la respuesta
   	xhr.onload = function() {
       	if (xhr.readyState == 4 && xhr.status == 201) { // 200 || 201
           	console.log("evio correcto " +xhr.response );
               solicitud();
       	} else {
           	console.log("Error: ${xhr.status}");
       	}
   	};
   	xhr.send(JSON.stringify(objeto_js));
}


function solicitud() {
    const xhr = new XMLHttpRequest();
    xhr.open("GET", "https://lm.iesnervion.es/reto4.php");
    xhr.responseType = "json";

    xhr.onload = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
            let data = xhr.response;
            console.log("Recepción:", data);
            mostrarProductos(data.lista);
            // Mostrar los títulos de los posts
            let titles = data.map(post => post.title);
            document.getElementById("datos").innerHTML = titles.join("<br>");
        } else {
            console.log("Error:", xhr.status);
        }
    };
    xhr.send();
}

function mostrarProductos(productos) {
    const tableBody = document.querySelector('#productTable tbody');
    tableBody.innerHTML = '';

    productos.forEach(producto => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${producto.id}</td>
        <td>${producto.descripcion}</td>
        <td>${producto.idProveedor}</td>
        <td>${producto.precio}</td>
      `;
      tableBody.appendChild(row);
    });
  }
</script>

</body>
</html>
